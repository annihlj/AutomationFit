<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fragebogen ‚Äì Automation Fit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phase234.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('index') }}" class="nav-logo">
                <img src="{{ url_for('static', filename='logo.svg') }}" alt="Automation Fit Logo">
                <span>Automation Fit</span>
            </a>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="active">Fragebogen</a>
                <a href="{{ url_for('comparison') }}">Vergleich</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="topbar">
            <div>
                <h1>
                    {% if edit_mode %}
                    ‚úèÔ∏è Assessment bearbeiten
                    {% else %}
                    Entscheidungsunterst√ºtzung: RPA vs. IPA
                    {% endif %}
                </h1>
                <p class="lead">
                    {% if edit_mode %}
                    <strong>Bearbeitungs-Modus:</strong> Passen Sie die Antworten an.
                    {% else %}
                    <strong>Phase 2-4:</strong> Dimensionen k√∂nnen einzeln ausgef√ºllt werden.
                    <br>
                    <span style="color: #16a34a;">‚úì</span> Alle Fragen sind optional - Submit ist jederzeit m√∂glich.
                    {% endif %}
                </p>
            </div>
            <span class="badge">{{ questionnaire.name }} ‚Ä¢ v{{ questionnaire.version }}</span>
        </div>

        <form class="card" method="post"
            action="{% if edit_mode %}{{ url_for('update_assessment', assessment_id=assessment_id) }}{% else %}{{ url_for('evaluate') }}{% endif %}"
            id="mainForm">

            <!-- Use-Case Metadaten -->
            <fieldset>
                <legend>Anwendungsfall</legend>
                <div class="grid grid-2">
                    <div>
                        <label for="uc_name">Bezeichnung <span class="req">*</span></label>
                        <input id="uc_name" name="uc_name" type="text" placeholder="z. B. Eingangsrechnungen pr√ºfen"
                            value="{% if edit_mode and process_data %}{{ process_data.name }}{% endif %}" required />
                    </div>
                    <div>
                        <label for="industry">Branche</label>
                        <input id="industry" name="industry" type="text" placeholder="z. B. Fertigung, Handel"
                            value="{% if edit_mode and process_data %}{{ process_data.industry }}{% endif %}" />
                    </div>
                </div>

                <label for="uc_desc">Kurzbeschreibung <span class="req">*</span></label>
                <textarea id="uc_desc" name="uc_desc" placeholder="Ziel, Ablauf in groben Schritten"
                    required>{% if edit_mode and process_data %}{{ process_data.description }}{% endif %}</textarea>
            </fieldset>

            <!-- Dimensionen & Fragen -->
            {% for dimension in dimensions %}
            <fieldset class="dimension" style="margin-top:1.5rem" data-dimension-id="{{ dimension.id }}">
                <legend class="dimension-legend">
                    <button type="button" class="dimension-toggle" aria-expanded="false"
                        aria-controls="dimension-panel-{{ dimension.id }}" id="dimension-toggle-{{ dimension.id }}">
                        <span>
                            {{ dimension.code }}. {{ dimension.name }}

                            <!-- Phase 2: Status Badge -->
                            <span class="dimension-status-badge" id="status-{{ dimension.id }}">
                                <span class="status-badge not-started">Nicht gestartet</span>
                            </span>

                            <!-- Phase 4: Shared Badge -->
                            {% if dimension.calc_method in ['filter', 'economic_score'] %}
                            <span class="shared-badge">Gemeinsam</span>
                            {% endif %}
                        </span>
                        <span class="dimension-chevron" aria-hidden="true">‚ñæ</span>
                    </button>
                </legend>

                <div class="dimension-panel" id="dimension-panel-{{ dimension.id }}" role="region"
                    aria-labelledby="dimension-toggle-{{ dimension.id }}">

                    {% for question in dimension.questions %}
                    <div class="question-item" data-question-id="{{ question.id }}"
                        data-question-code="{{ question.code }}" data-dimension-id="{{ dimension.id }}" {% if
                        question.depends_on %} data-depends-on-question="{{ question.depends_on }}"
                        data-depends-on-option="{{ question.depends_on_option }}" {% endif %} style="margin-bottom:1.5rem; padding:1rem; background:#f9fafb; border-radius:0.5rem;
                         {% if question.depends_on and not edit_mode %}display:none;{% endif %}">

                        <label style="font-weight:600; display:block; margin-bottom:0.5rem">
                            {{ question.code }} - {{ question.text }}
                            <span style="color:#6b7280; font-weight:normal; font-size:0.9em">Info</span>
                        </label>

                        {% if question.type == 'number' %}
                        <!-- Number Input -->
                        <input type="number" name="q_{{ question.id }}" min="0" step="any"
                            placeholder="Wert eingeben{% if question.unit %} ({{ question.unit }}){% endif %}"
                            value="{% if question.answer is not none %}{{ question.answer }}{% endif %}"
                            data-dimension-id="{{ dimension.id }}" style="max-width:300px" />
                        {% if question.unit %}
                        <span style="margin-left:0.5rem; color:#6b7280">{{ question.unit }}</span>
                        {% endif %}

                        {% elif question.type == 'single_choice' %}
                        <!-- Single Choice -->
                        <div class="likert" role="radiogroup">
                            <div class="likert-row likert-{{ question.options|length }}">
                                {% for option in question.options %}
                                <label class="likert-item {% if option.is_na %}is-na{% endif %}">
                                    <span class="likert-label">{{ option.label }}</span>
                                    <input class="likert-input filter-trigger" type="radio" name="q_{{ question.id }}"
                                        value="{{ option.id }}" data-option-code="{{ option.code }}"
                                        data-option-id="{{ option.id }}" data-question-id="{{ question.id }}"
                                        data-dimension-id="{{ dimension.id }}" {% if question.answer==option.id
                                        %}checked{% endif %} />
                                    <span class="likert-circle" aria-hidden="true"></span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Hints -->
                        {% if question.hints %}
                        <div class="hints-container">
                            {% for option in question.options %}
                            {% if option.id in question.hints %}
                            {% for hint in question.hints[option.id] %}
                            <div class="hint hint-{{ hint.type }}" style="display:none;"
                                data-option-id="{{ option.id }}" data-question-id="{{ question.id }}">
                                <span class="hint-icon">
                                    {% if hint.type == 'error' %}‚ö†Ô∏è
                                    {% elif hint.type == 'warning' %}‚ö°
                                    {% else %}‚ÑπÔ∏è{% endif %}
                                </span>
                                <span class="hint-text">{{ hint.text }}</span>
                            </div>
                            {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% elif question.type == 'multiple_choice' %}
                        <!-- Multiple Choice -->
                        <div class="checkbox-group" role="group">
                            <div class="checkbox-row checkbox-{{ question.options|length }}">
                                {% for option in question.options %}
                                <label class="checkbox-item {% if option.is_na %}is-na{% endif %}">
                                    <span class="checkbox-label">{{ option.label }}</span>
                                    <input class="checkbox-input" type="checkbox" name="q_{{ question.id }}[]"
                                        value="{{ option.id }}" data-option-code="{{ option.code }}"
                                        data-dimension-id="{{ dimension.id }}" {% if question.answer and option.id in
                                        question.answer %}checked{% endif %} />
                                    <span class="checkbox-box" aria-hidden="true"></span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </fieldset>
            {% endfor %}

            <!-- Submit Actions -->
            <div class="actions">
                {% if edit_mode %}
                <a href="{{ url_for('view_assessment', assessment_id=assessment_id) }}" class="secondary">Abbrechen</a>
                <button type="submit">√Ñnderungen speichern & neu auswerten</button>
                {% else %}
                <button type="reset" class="secondary">Zur√ºcksetzen</button>
                <button type="submit">Bewertung berechnen</button>
                {% endif %}
            </div>
        </form>
    </div>

    <script>
        console.log("üöÄ Filterlogik-Script l√§dt...");

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById('mainForm');

            // ===== FILTERLOGIK - ZENTRALE FUNKTION =====
            /**
             * Diese Funktion steuert das Ein-/Ausblenden von abh√§ngigen Fragen
             * 
             * Funktionsweise:
             * 1. Wenn eine Frage beantwortet wird (z.B. Frage 1.1)
             * 2. Suche alle Fragen die von dieser abh√§ngen
             * 3. Pr√ºfe ob die gew√§hlte Option die richtige ist (depends_on_option)
             * 4. Wenn JA: Zeige abh√§ngige Fragen
             * 5. Wenn NEIN: Verstecke abh√§ngige Fragen
             */
            function applyFilterLogic(questionId, selectedOptionId) {
                console.log(`\nüîç Filter-Check: Frage ${questionId}, Option ${selectedOptionId}`);

                // Finde alle Fragen die von dieser Frage abh√§ngen
                const dependentQuestions = document.querySelectorAll(
                    `[data-depends-on-question="${questionId}"]`
                );

                console.log(`   Gefunden: ${dependentQuestions.length} abh√§ngige Fragen`);

                dependentQuestions.forEach(depQuestion => {
                    const requiredOptionId = depQuestion.dataset.dependsOnOption;
                    const questionCode = depQuestion.dataset.questionCode;

                    // Pr√ºfe: Ist die gew√§hlte Option die richtige?
                    if (selectedOptionId == requiredOptionId) {
                        // JA ‚Üí Zeige Frage
                        depQuestion.style.display = 'block';
                        console.log(`   ‚úÖ ${questionCode} eingeblendet (Option ${selectedOptionId} = ${requiredOptionId})`);
                    } else {
                        // NEIN ‚Üí Verstecke Frage und l√∂sche Antworten
                        depQuestion.style.display = 'none';

                        // L√∂sche alle Inputs in dieser Frage
                        depQuestion.querySelectorAll('input[type="radio"]:checked').forEach(r => r.checked = false);
                        depQuestion.querySelectorAll('input[type="checkbox"]:checked').forEach(c => c.checked = false);
                        depQuestion.querySelectorAll('input[type="number"]').forEach(n => n.value = '');

                        console.log(`   üîí ${questionCode} ausgeblendet (Option ${selectedOptionId} ‚â† ${requiredOptionId})`);
                    }

                    // Rekursiv: Wenn diese abh√§ngige Frage auch Kinder hat, behandle die auch
                    const depQuestionId = depQuestion.dataset.questionId;
                    const checkedRadio = depQuestion.querySelector('input[type="radio"]:checked');
                    if (checkedRadio && depQuestion.style.display === 'none') {
                        // Frage wurde ausgeblendet ‚Üí trigger Filter f√ºr deren Kinder
                        applyFilterLogic(depQuestionId, null);
                    }
                });
            }

            // ===== EVENT LISTENER - Reagiere auf Radio-Button √Ñnderungen =====
            document.querySelectorAll('.filter-trigger').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const questionId = e.target.dataset.questionId;
                    const selectedOptionId = e.target.value;

                    console.log(`\nüìª Radio ge√§ndert: Frage ${questionId} ‚Üí Option ${selectedOptionId}`);

                    // Wende Filter an
                    applyFilterLogic(questionId, selectedOptionId);

                    // Zeige Hints
                    showHintsForOption(questionId, selectedOptionId);

                    // Update Status
                    const dimensionId = e.target.dataset.dimensionId;
                    if (dimensionId) {
                        updateDimensionStatus(dimensionId);
                    }
                });
            });

            // ===== INITIAL: Filter beim Laden anwenden (Edit-Modus) =====
            console.log("\nüîÑ Initial-Filter wird angewendet...");
            document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const questionId = radio.dataset.questionId;
                const selectedOptionId = radio.value;

                if (questionId && selectedOptionId) {
                    console.log(`   Initial: Frage ${questionId} = Option ${selectedOptionId}`);
                    applyFilterLogic(questionId, selectedOptionId);
                }
            });

            // ===== HINTS =====
            function showHintsForOption(questionId, optionId) {
                // Verstecke alle Hints dieser Frage
                const allHints = document.querySelectorAll(`[data-question-id="${questionId}"].hint`);
                allHints.forEach(h => h.style.display = 'none');

                // Zeige Hints f√ºr gew√§hlte Option
                const selectedHints = document.querySelectorAll(
                    `[data-question-id="${questionId}"][data-option-id="${optionId}"].hint`
                );
                selectedHints.forEach(h => h.style.display = 'flex');
            }

            // ===== STATUS TRACKING =====
            function updateDimensionStatus(dimensionId) {
                const dimension = document.querySelector(`[data-dimension-id="${dimensionId}"]`);
                if (!dimension) return;

                const visibleQuestions = dimension.querySelectorAll(
                    '.question-item:not([style*="display:none"]):not([style*="display: none"])'
                );

                let totalQuestions = 0;
                let answeredQuestions = 0;

                visibleQuestions.forEach(q => {
                    const qid = q.dataset.questionId;
                    totalQuestions++;

                    const numberInput = q.querySelector(`input[type="number"][name="q_${qid}"]`);
                    const radioChecked = form.querySelector(`input[name="q_${qid}"]:checked`);
                    const checkboxChecked = form.querySelectorAll(`input[name="q_${qid}[]"]:checked`).length > 0;

                    if ((numberInput && numberInput.value.trim() !== '') || radioChecked || checkboxChecked) {
                        answeredQuestions++;
                    }
                });

                let status = 'not_started';
                let badgeHtml = '';

                if (answeredQuestions === 0) {
                    status = 'not_started';
                    badgeHtml = '<span class="status-badge not-started">Nicht gestartet</span>';
                } else if (answeredQuestions < totalQuestions) {
                    status = 'partial';
                    badgeHtml = `<span class="status-badge partial">Teilweise (${answeredQuestions}/${totalQuestions})</span>`;
                } else {
                    status = 'complete';
                    badgeHtml = '<span class="status-badge complete">Vollst√§ndig ‚úì</span>';
                }

                const statusBadge = document.getElementById(`status-${dimensionId}`);
                if (statusBadge) {
                    statusBadge.innerHTML = badgeHtml;
                }
            }

            // Event Listener f√ºr Status-Updates
            form.addEventListener('change', (e) => {
                const dimensionId = e.target.dataset.dimensionId;
                if (dimensionId) {
                    updateDimensionStatus(dimensionId);
                }
            });

            // Initial Status
            document.querySelectorAll('[data-dimension-id]').forEach(dim => {
                const dimId = dim.dataset.dimensionId;
                if (dimId) {
                    updateDimensionStatus(dimId);
                }
            });

            // ===== DIMENSION TOGGLE =====
            // ===== Dimension Toggle Logic =====
            const toggles = document.querySelectorAll(".dimension-toggle");

            toggles.forEach((btn) => {
                const panelId = btn.getAttribute("aria-controls");
                const panel = document.getElementById(panelId);

                // Initialzustand beim Laden setzen
                const isExpanded = btn.getAttribute("aria-expanded") === "true";
                panel.hidden = !isExpanded;

                btn.addEventListener("click", () => {
                    const expanded = btn.getAttribute("aria-expanded") === "true";

                    // Toggle Zustand
                    btn.setAttribute("aria-expanded", String(!expanded));
                    panel.hidden = expanded;

                    // Die Text√§nderung (chevron.textContent) haben wir gel√∂scht, 
                    // da das CSS nun die Rotation √ºbernimmt!
                });
            });

            // ===== CHECKBOX EXCLUSIVE LOGIC =====
            document.querySelectorAll('.question-item').forEach(qItem => {
                const qid = qItem.dataset.questionId;
                if (!qid) return;

                const checkboxes = qItem.querySelectorAll(`input[type="checkbox"][name="q_${qid}[]"]`);
                if (!checkboxes.length) return;

                const isSpecial = (cb) => cb.dataset.optionCode === "NONE" || cb.dataset.optionCode === "KA";
                const specialBoxes = Array.from(checkboxes).filter(isSpecial);
                const normalBoxes = Array.from(checkboxes).filter(cb => !isSpecial(cb));

                checkboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        if (isSpecial(cb) && cb.checked) {
                            normalBoxes.forEach(n => n.checked = false);
                            specialBoxes.forEach(s => { if (s !== cb) s.checked = false; });
                        }
                        if (!isSpecial(cb) && cb.checked) {
                            specialBoxes.forEach(s => s.checked = false);
                        }
                    });
                });
            });

            console.log("‚úÖ Filterlogik-Script geladen!");
        });
    </script>
</body>

</html>