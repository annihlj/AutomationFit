<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fragebogen ‚Äì Automation Fit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('index') }}" class="nav-logo">
                <img src="{{ url_for('static', filename='logo.svg') }}" alt="Automation Fit Logo">
                <span>Automation Fit</span>
            </a>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="active">Fragebogen</a>
                <a href="{{ url_for('comparison') }}">Vergleich</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="topbar">
            <div>
                <h1>
                    {% if edit_mode %}
                    ‚úèÔ∏è Assessment bearbeiten
                    {% else %}
                    Entscheidungsunterst√ºtzung: RPA vs. IPA
                    {% endif %}
                </h1>
                <p class="lead">
                    {% if edit_mode %}
                    <strong>Bearbeitungs-Modus:</strong> Passen Sie die Antworten an und speichern Sie die √Ñnderungen.
                    {% else %}
                    Bitte erfassen Sie den Anwendungsfall und beantworten Sie die Fragen.
                    <br>
                    <strong>Phase 1:</strong> Alle Fragen k√∂nnen beantwortet werden.
                    Unbeantwortete Fragen werden gespeichert und bei der Auswertung √ºbersprungen.
                    {% endif %}
                </p>
            </div>
            <span class="badge">{{ questionnaire.name }} ‚Ä¢ v{{ questionnaire.version }}</span>
        </div>

        <!-- ‚≠ê Form Action basierend auf Edit-Modus -->
        <form class="card" method="post"
            action="{% if edit_mode %}{{ url_for('update_assessment', assessment_id=assessment_id) }}{% else %}{{ url_for('evaluate') }}{% endif %}"
            id="mainForm">

            <!-- 1) Use-Case Metadaten -->
            <fieldset>
                <legend>Anwendungsfall</legend>
                <div class="grid grid-2">
                    <div>
                        <label for="uc_name">Bezeichnung <span class="req">*</span></label>
                        <input id="uc_name" name="uc_name" type="text" placeholder="z. B. Eingangsrechnungen pr√ºfen"
                            value="{% if edit_mode and process_data %}{{ process_data.name }}{% endif %}" required />
                    </div>
                    <div>
                        <label for="industry">Branche</label>
                        <input id="industry" name="industry" type="text"
                            placeholder="z. B. Fertigung, Handel, Dienstleistung"
                            value="{% if edit_mode and process_data %}{{ process_data.industry }}{% endif %}" />
                    </div>
                </div>

                <label for="uc_desc">Kurzbeschreibung <span class="req">*</span></label>
                <textarea id="uc_desc" name="uc_desc" placeholder="Ziel, Ablauf in groben Schritten, beteiligte Systeme"
                    required>{% if edit_mode and process_data %}{{ process_data.description }}{% endif %}</textarea>
            </fieldset>

            <!-- 2) Dimensionen & Fragen -->
            {% for dimension in dimensions %}
            <fieldset class="dimension" style="margin-top:1.5rem">
                <legend class="dimension-legend">
                    <button type="button" class="dimension-toggle" aria-expanded="false"
                        aria-controls="dimension-panel-{{ dimension.id }}" id="dimension-toggle-{{ dimension.id }}">
                        <span>{{ dimension.code }}. {{ dimension.name }}</span>
                        <span class="dimension-chevron" aria-hidden="true">‚ñæ</span>
                    </button>
                </legend>

                <div class="dimension-panel" id="dimension-panel-{{ dimension.id }}" role="region"
                    aria-labelledby="dimension-toggle-{{ dimension.id }}">

                    {% for question in dimension.questions %}
                    <div class="question-item" data-question-id="{{ question.id }}"
                        style="margin-bottom:1.5rem; padding:1rem; background:#f9fafb; border-radius:0.5rem">

                        <label style="font-weight:600; display:block; margin-bottom:0.5rem">
                            {{ question.code }} - {{ question.text }}
                            <span style="color:#6b7280; font-weight:normal; font-size:0.9em">
                                (Optional - kann √ºbersprungen werden)
                            </span>
                        </label>

                        {% if question.type == 'number' %}
                        <!-- Number Input -->
                        <input type="number" name="q_{{ question.id }}" min="0" step="1"
                            placeholder="Wert eingeben{% if question.unit %} ({{ question.unit }}){% endif %}"
                            value="{% if question.answer is not none %}{{ question.answer }}{% endif %}"
                            style="max-width:300px" />
                        {% if question.unit %}
                        <span style="margin-left:0.5rem; color:#6b7280">{{ question.unit }}</span>
                        {% endif %}

                        {% elif question.type == 'single_choice' %}
                        <!-- Single Choice (Radio Buttons) -->
                        <div class="likert" role="radiogroup" aria-label="{{ question.code }}">
                            <div class="likert-row likert-{{ question.options|length }}">
                                {% for option in question.options %}
                                <label class="likert-item {% if option.is_na %}is-na{% endif %}">
                                    <span class="likert-label">{{ option.label }}</span>
                                    <input class="likert-input" type="radio" name="q_{{ question.id }}"
                                        value="{{ option.id }}" data-option-code="{{ option.code }}"
                                        data-is-na="{{ '1' if option.is_na else '0' }}" {% if question.answer==option.id
                                        %}checked{% endif %} />
                                    <span class="likert-circle" aria-hidden="true"></span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        {% elif question.type == 'multiple_choice' %}
                        <!-- Multiple Choice (Checkboxes) -->
                        <div class="checkbox-group" role="group" aria-label="{{ question.code }}">
                            <div class="checkbox-row checkbox-{{ question.options|length }}">
                                {% for option in question.options %}
                                <label class="checkbox-item {% if option.is_na %}is-na{% endif %}">
                                    <span class="checkbox-label">{{ option.label }}</span>
                                    <input class="checkbox-input" type="checkbox" name="q_{{ question.id }}[]"
                                        value="{{ option.id }}" data-option-code="{{ option.code }}"
                                        data-is-na="{{ '1' if option.is_na else '0' }}" {% if question.answer and
                                        option.id in question.answer %}checked{% endif %} />
                                    <span class="checkbox-box" aria-hidden="true"></span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </fieldset>
            {% endfor %}

            <!-- 3) Submit Actions -->
            <div class="actions">
                {% if edit_mode %}
                <a href="{{ url_for('view_assessment', assessment_id=assessment_id) }}" class="secondary">Abbrechen</a>
                <button type="submit">√Ñnderungen speichern & neu auswerten</button>
                {% else %}
                <button type="reset" class="secondary">Zur√ºcksetzen</button>
                <button type="submit">Bewertung berechnen</button>
                {% endif %}
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // ===== Dimension Toggle Logic =====
            const toggles = document.querySelectorAll(".dimension-toggle");

            toggles.forEach((btn) => {
                const panelId = btn.getAttribute("aria-controls");
                const panel = document.getElementById(panelId);

                // Initial: collapsed
                const isExpanded = btn.getAttribute("aria-expanded") === "true";
                panel.hidden = !isExpanded;

                const chevron = btn.querySelector('.dimension-chevron');
                if (chevron) chevron.textContent = isExpanded ? '‚ñæ' : '‚ñ∏';

                btn.addEventListener("click", () => {
                    const expanded = btn.getAttribute("aria-expanded") === "true";
                    btn.setAttribute("aria-expanded", String(!expanded));
                    panel.hidden = expanded;
                    if (chevron) chevron.textContent = expanded ? '‚ñ∏' : '‚ñæ';
                });
            });

            // ===== Multiple-Choice Exclusive Logic =====
            // "Keine Angabe" (is_na) und "Keine der genannten" (code=NONE) sind exklusiv
            document.querySelectorAll('.question-item').forEach(qItem => {
                const qid = qItem.dataset.questionId;
                if (!qid) return;

                const checkboxes = qItem.querySelectorAll(`input[type="checkbox"][name="q_${qid}[]"]`);
                if (!checkboxes.length) return;

                const isSpecial = (cb) => {
                    return cb.dataset.isNa === "1" || cb.dataset.optionCode === "NONE";
                };

                const specialBoxes = Array.from(checkboxes).filter(isSpecial);
                const normalBoxes = Array.from(checkboxes).filter(cb => !isSpecial(cb));

                checkboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        // Wenn Special (NA oder NONE) angehakt ‚Üí alle normalen abw√§hlen
                        if (isSpecial(cb) && cb.checked) {
                            normalBoxes.forEach(n => n.checked = false);
                            // Andere Specials ebenfalls abw√§hlen
                            specialBoxes.forEach(s => { if (s !== cb) s.checked = false; });
                        }

                        // Wenn normal angehakt ‚Üí Specials abw√§hlen
                        if (!isSpecial(cb) && cb.checked) {
                            specialBoxes.forEach(s => s.checked = false);
                        }
                    });
                });
            });

            // ===== PHASE 1: KEINE strikte Validierung =====
            // In Phase 1 k√∂nnen Fragen √ºbersprungen werden
            // Das Submit wird NICHT blockiert
            const form = document.getElementById('mainForm');
            if (form) {
                form.addEventListener('submit', (e) => {
                    // Nur Use-Case Pflichtfelder m√ºssen ausgef√ºllt sein
                    // Das HTML5 required-Attribut k√ºmmert sich darum

                    {% if edit_mode %}
                    console.log('‚úÖ Edit-Modus: Assessment wird aktualisiert');
                    {% else %}
                    console.log('‚úÖ Phase 1: Form submitted - unbeantwortete Fragen werden als NULL gespeichert');
                    {% endif %}

                    // Optional: Statistik anzeigen
                    const allQuestions = document.querySelectorAll('.question-item');
                    let answeredCount = 0;

                    allQuestions.forEach(q => {
                        const qid = q.dataset.questionId;
                        const numberInput = q.querySelector(`input[type="number"][name="q_${qid}"]`);
                        const radioChecked = form.querySelector(`input[name="q_${qid}"]:checked`);
                        const checkboxChecked = form.querySelectorAll(`input[name="q_${qid}[]"]:checked`).length > 0;

                        if ((numberInput && numberInput.value.trim() !== '') || radioChecked || checkboxChecked) {
                            answeredCount++;
                        }
                    });

                    console.log(`üìä ${answeredCount} von ${allQuestions.length} Fragen beantwortet`);
                });
            }
        });
    </script>
</body>

</html>